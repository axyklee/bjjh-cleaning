# D1 Database Migrations (Drizzle ORM)

This directory contains SQL migration files for Cloudflare D1 generated by Drizzle Kit.

## Generating Migrations

When you make changes to `src/server/db/schema.ts`, generate migrations:

```bash
# Generate migration files
yarn db:generate

# Or manually:
npx drizzle-kit generate
```

This will create timestamped migration files in the `drizzle/` directory.

## Applying Migrations

### Local Development

Push schema directly to local SQLite database:

```bash
DATABASE_URL="file:./dev.db" yarn db:push

# Or manually:
DATABASE_URL="file:./dev.db" npx drizzle-kit push
```

### Production (Cloudflare D1)

Apply migrations to your D1 database:

```bash
# Apply migrations using wrangler
yarn cf:d1:migrate

# Or manually:
npx wrangler d1 migrations apply bjjh-cleaning-db --remote
```

## Migration Workflow

1. **Update Schema**: Modify `src/server/db/schema.ts`
2. **Generate Migration**: Run `yarn db:generate`
3. **Review Migration**: Check generated SQL in `drizzle/` directory
4. **Test Locally**: Run `DATABASE_URL="file:./dev.db" yarn db:push`
5. **Apply to Production**: Run `yarn cf:d1:migrate`

## Drizzle Studio

View and edit your database with Drizzle Studio:

```bash
yarn db:studio

# Or manually:
DATABASE_URL="file:./dev.db" npx drizzle-kit studio
```

This opens a web interface at http://localhost:4983 for browsing your database.

## Initial Setup

For a fresh database, the migrations will be generated from your schema:

```bash
# 1. Generate initial migrations
yarn db:generate

# 2. Test locally
DATABASE_URL="file:./dev.db" yarn db:push

# 3. Apply to D1
yarn cf:d1:migrate
```
